#!/bin/bash

SIGIL=$1
SRCHOST=$2
SRC=$3
TARGET=$4

TEMPFILE=/var/tmp/rsigil-$RANDOM
SRCLEN=$((${#SRC} + 2))

# TODO: Use ssh-agent to avoid multiple passwords.
# TODO: Skip ssh for local copies.
ssh $SRCHOST "find $SRC -name .$SIGIL -printf %h\\\\n" > $TEMPFILE
cut -c$SRCLEN- $TEMPFILE \
    | rsync -vrt --files-from=- --delete --exclude=.* $SRCHOST:$SRC $TARGET/
rm $TEMPFILE
